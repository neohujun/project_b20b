/******************************************************************************
**
**								Copyright (C) 2015  
**				Smartauto(China) Automotive Information System Co.,Ltd.
**								All rights reserved.
**
**----------------------------------File Info----------------------------------
**
**	Filename:		iic.c
**	Abstract:		iic driver
**	Creat By:		Zeno Liu
**	Creat Time:		2015.03.10
**	Version:		v1.0
**
******************************************************************************/

/* \brief
	include files
*/
#include "Drv_IIC.h"
#include "Timer.h"
#include <MC9S08DZ60.h>
#include <hidef.h>

/* \brief
*/
#define	iicADDR_W			0x8A
#define	iicADDR_R			0x8B

/* \brief
*/

static BOOL bIICStart(void);
static BOOL bIICSend8Bit(BYTE data);
static BOOL blIICWrite (BYTE index, BYTE value);
static BOOL blIICWriteStart(void);
static BOOL blWaitSignalOk(BYTE* pSignal, BYTE SignalBit, BOOL OkSignal, WORD wCounter);


static BYTE IICError;

const BYTE LvdsIn_Para[] = 
{
0xFF, 0x00,  //; Page 0
0x02, 0xC8,
0x03, 0xE8,
0x04, 0x00,
0x06, 0x06,
0x07, 0x0A,	//0x02  bt656 disable
0x08, 0x87,
0x0F, 0x80,
0x1F, 0x00,
0x40, 0x03,
0x41, 0x81,
0x42, 0x53,
0x43, 0x0D,
0x44, 0x60,
0x45, 0x12,
0x46, 0xCD,
0x47, 0x00,
0x48, 0x40,
0x4B, 0x00,
0x50, 0x00,
0x51, 0x00,
0x52, 0x00,
0x53, 0x05,
0x54, 0x00,
0x56, 0x00,
0x57, 0x00,
0x5F, 0x01,
0x60, 0x00,
0x66, 0x00,
0x67, 0x00,
0x68, 0x00,
0x69, 0x02,
0x6A, 0x20,
0x6B, 0xF0,
0x6C, 0x20,
0x6D, 0xD0,
0x6E, 0x10,
0x6F, 0x10,
0x70, 0x00,
0xD4, 0x00,
0xE7, 0x16,
0xE8, 0x01,
0xE9, 0x77,
0xEA, 0x00,
0xEB, 0x40,
0xEC, 0x30,
0xED, 0x21,
0xF6, 0x00,
0xF7, 0x16,
0xF8, 0x01,	//0x01
0xF9, 0xEE,	//0xD2
0xFA, 0x00,
0xFB, 0x40,
0xFC, 0x23,
0xFD, 0x24,

0xFF, 0x01,  //; Page 1
0x01, 0x91,
0x02, 0x40,
0x04, 0x00,
0x05, 0x00,
0x06, 0x00,	//0x00  0x08 clk Down
0x07, 0x02,
0x08, 0x15,
0x09, 0xF0,	//0xF0
0x0A, 0x0F,
0x0B, 0xD0,
0x0C, 0xDC,
0x0D, 0x00,
0x10, 0x00,
0x11, 0x80,
0x12, 0x17,
0x13, 0x80,
0x14, 0x80,
0x15, 0x00,
0x17, 0x34,
0x18, 0x44,
0x1A, 0x10,
0x1B, 0x00,
0x1C, 0x27,
0x1D, 0x7F,
0x1E, 0x00,
0x1F, 0x00,
0x20, 0x50,
0x21, 0x22,
0x22, 0xF0,
0x23, 0xD8,
0x24, 0xBC,
0x25, 0xB8,
0x26, 0x44,
0x27, 0x30,
0x28, 0x00,
0x29, 0x00,
0x2A, 0x78,
0x2B, 0x44,
0x2C, 0x30,
0x2D, 0x14,
0x2E, 0xA5,
0x2F, 0xE4,
0x30, 0xD0,
0x31, 0x00,
0x32, 0x00,
0x33, 0x05,
0x34, 0x1A,
0x35, 0x00,
0x36, 0x03,
0x37, 0x28,
0x38, 0xAF,
0x40, 0x00,
0x41, 0x80,
0x42, 0x00,
0xC0, 0x21,
0xC1, 0xF7,
0xC2, 0xF4,
0xC3, 0x03,
0xC4, 0x8A,
0xC5, 0x1A,
0xC6, 0x20,
0xC7, 0x04,
0xC8, 0x00,
0xC9, 0x10,
0xCA, 0x10,
0xCB, 0xF6,
0xCC, 0x00,
0xCD, 0x54,
0xD0, 0x07,
0xD1, 0x82,
0xD2, 0x82,
0xD3, 0x82,
0xD4, 0x20,
0xD5, 0x00,
0xD6, 0x2C,
0xD7, 0x40,
0xD8, 0x00,
0xD9, 0x08,
0xDA, 0x08,
0xDB, 0x08,
0xDC, 0x0F,
0xE0, 0x00,
0xE1, 0x05,
0xE2, 0x59,
0xE3, 0x07,
0xE4, 0x33,
0xE5, 0x33,
0xE6, 0x00,
0xE7, 0x15,
0xE8, 0x21,
0xE9, 0x00,
0xEA, 0x03,
0xF6, 0x30,
0xF7, 0x00,
0xF8, 0x00,
0xF9, 0x00,
0xFA, 0x38,

0xFF, 0x02,  //; Page 2
0x01, 0x00,
0x02, 0x60,
0x03, 0x00,
0x04, 0x20,
0x05, 0x00,
0x06, 0x20,
0x07, 0x3F,
0x08, 0x21,
0x09, 0x00,
0x0A, 0x04,
0x0B, 0x12,
0x0C, 0x10,
0x0D, 0x84,
0x0E, 0x50,
0x0F, 0x02,
0x10, 0x35,
0x11, 0xC1,
0x12, 0x13,
0x13, 0x10,
0x14, 0x0A,
0x15, 0x14,
0x16, 0x00,
0x17, 0x05,
0x18, 0x8E,
0x19, 0x29,
0x1A, 0x00,
0x1B, 0x00,
0x1C, 0x32,
0x1D, 0xF4,
0x1E, 0x02,
0x20, 0x00,
0x21, 0x00,
0x40, 0x10,
0x41, 0x00,
0x42, 0x05,
0x43, 0x01,
0x44, 0x64,
0x45, 0xF4,
0x46, 0x00,
0x47, 0x0A,
0x48, 0x36,
0x49, 0x10,
0x4A, 0x00,
0x4B, 0x00,
0x4C, 0x00,
0x4D, 0x44,
0x4E, 0x04,
0x80, 0x20,
0x81, 0x80,
0x82, 0x80,
0x83, 0x80,
0x84, 0x80,
0x85, 0x80,
0x86, 0x80,
0x87, 0x80,
0x88, 0x80,
0x89, 0x80,
0x8A, 0x80,
0x8B, 0x30,
0x8C, 0x00,
0xB0, 0x10,
0xB1, 0x40,
0xB2, 0x40,
0xB6, 0x67,
0xB7, 0x94,
0xBF, 0x7C,
0xE0, 0x00,
0xE1, 0x00,
0xE2, 0x00,
0xE3, 0x00,
0xE4, 0x21,
0xF8, 0x00,
0xF9, 0x80,

0xFF, 0x03,  //; Page 3

0xFF, 0x04,  //; Page 4
0x04, 0x00,	//0x30 old img
0x05, 0x00,	//0x85
0x06, 0x00,	//0x10
0x07, 0x00,	//0x4A
0xC0, 0x03,
0xC1, 0x60,
0xC2, 0x00,
0xC3, 0x85,
0xC4, 0x00,
0xC5, 0x80,
0xC6, 0x00,
0xC7, 0x00,
0xC8, 0x01,
0xC9, 0x00,
0xCA, 0x6B,
0xCB, 0x18,
0xCC, 0xB4,
0xCD, 0x80,
0xCE, 0x00,
0xCF, 0x1F,
0xD0, 0xB2,
0xD1, 0x56,
0xD2, 0x00,
0xD3, 0x00,
0xD4, 0x01,
0xD5, 0x3F,
0xD6, 0x64,
0xD7, 0x01,
0xD8, 0x05,
0xD9, 0x08,
0xDA, 0x00,
0xDB, 0x00,
0xDC, 0x01,
0xDD, 0x88,
0xDE, 0x00,
0xDF, 0x00,
0xE0, 0x00,
0xE1, 0x20,
0xE2, 0x00,
0xE3, 0x90,
0xE4, 0x00,
0xE5, 0x90,
0xE6, 0x00,
0xE7, 0x90,
0xE8, 0x00,
0xE9, 0x0C,
0xEA, 0x00,
0xEB, 0x0C,
0xF0, 0x00,
0xF1, 0x00,
0xF2, 0x00,
0xF3, 0x40,
0xF4, 0x00,
0xF5, 0x00,
0xF6, 0x04,
0xF7, 0x90,
0xF8, 0x00,
0xF9, 0x00,
0xFA, 0x00,
0xFB, 0x00,
0xFC, 0x00,
0xFD, 0x00,
0xFE, 0x00,

0xFF, 0x05,  //; Page 5

0xFF, 0x06,  //; Page 6
0x40, 0x0C,
0x41, 0x00,
0x42, 0x01,
0x43, 0xC0,
0x44, 0x00,
0x46, 0x01,
0x48, 0x07,
0x49, 0x01,
0x4A, 0x00,
0x4B, 0x30,
0x4C, 0x40,
0x4D, 0x17,
0x4E, 0x00,

0xFF,0xFE,
};

/* \brief
*/
static BOOL blWaitSignalOk(BYTE* pSignal, BYTE SignalBit, BOOL OkSignal, WORD wCounter)
{
	for(; 0!=wCounter; --wCounter)
	{
		if(((*pSignal>>SignalBit)&0x01) == OkSignal)
		{
			return TRUE;
		}

		__RESET_WATCHDOG();
	}
	
	return FALSE;
}


/* \brief
	IIC start
*/
static BOOL bIICStart(void)
{
	IICC1_IICEN = 0;
	IICC1_IICEN = 1;			//reset iic
 
	IICC1_TXAK = 0;			//产生应答信号
	
	IICS_ARBL = 1;			//Clear any pending interrupt
	IICS_IICIF = 1;
	IICS_TCF = 1;

	IICS_SRW = 0;
	IICC1_TX = 1;
	IICC1_MST = 0;
	TimerWait(1);
	if(!blWaitSignalOk(&IICS, 5, 0, 20000))
	{
		++IICError;
		IICC1_MST = 0;
		return FALSE;
	}
	IICC1_MST = 1;
	TimerWait(1);
	
	return TRUE;
	
}

/* \brief
	IIC start
*/
static BOOL bIICSend8Bit(BYTE data)
{
//	IIC_temp = data;
	
	IICD = data;
	if(!blWaitSignalOk(&IICS, 1, 1, 20000))
	{
		++IICError;
		IICC1_MST = 0;
		return FALSE;
	}
	IICS_IICIF = 1;
	
	if(!blWaitSignalOk(&IICS, 0, 0, 20000))
	{
		++IICError;
		IICC1_MST = 0;
		return FALSE;
	}
	
	return TRUE;
}

static BOOL blIICWrite (BYTE index, BYTE value)
{

	if(!bIICStart())
	{
		return FALSE;
	}

	if(!bIICSend8Bit(iicADDR_W))
	{
		return FALSE;
	}

	if(!bIICSend8Bit(index))
	{
		return FALSE;
	}

	if(!bIICSend8Bit(value))
	{
		return FALSE;
	}
	
	IICC1_MST = 0;
	TimerWait(1);
	
	return TRUE;
}

/* \brief
	IIC read
*/
/*
static BOOL blIICWrite (BYTE index, BYTE value)
{

	if(!bIICSend8Bit(index))
	{
		return FALSE;
	}

	if(!bIICSend8Bit(value))
	{
		return FALSE;
	}
	TimerWait(1);
	return TRUE;
}

static BOOL blIICWriteStart(void)
{
	if(!bIICStart())
	{
		return FALSE;
	}

	if(!bIICSend8Bit(iicADDR_W))
	{
		return FALSE;
	}
	
	return TRUE;
}
*/

/* \brief
	IIC initialization
*/
void vIICInit(BYTE SelfAddr)
{
	IICA = SelfAddr;
	
	IICC1_IICEN = 0;
	IICF_MULT =  0x00;
	IICF_ICR = 0x0B;			// 0x1E :bps = 16M/(1 * 192) = 83.333 kHz  // 0x0B: 40      400KHz
//	SOPT1_IICPS = 1;			//select PTE4,PTE5
	
//	IICC1_IICIE = 1;
	IICC1_IICEN = 1;

	IICError = 0;
}

void vIICWriteDrvConfig(void)
{
	WORD i = 0;
	WORD j = 0;

//	blIICWriteStart();

  	while(j < 5000)
	{
		if((0xFF == LvdsIn_Para[i]) && (0xFE == LvdsIn_Para[i + 1]))
		{
			break;
		}
		blIICWrite(LvdsIn_Para[i],LvdsIn_Para[i + 1]);
		i += 2;
		j++;
	}
	
//	IICC1_MST = 0;
	
}


